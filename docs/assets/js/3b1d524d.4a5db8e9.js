"use strict";(self.webpackChunktest_website=self.webpackChunktest_website||[]).push([[215],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return m}});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var c=a.createContext({}),s=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=s(e.components);return a.createElement(c.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,c=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=s(n),m=o,h=d["".concat(c,".").concat(m)]||d[m]||p[m]||r;return n?a.createElement(h,i(i({ref:t},u),{},{components:n})):a.createElement(h,i({ref:t},u))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=d;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var s=2;s<r;s++)i[s]=n[s];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},8951:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return c},metadata:function(){return s},toc:function(){return u},default:function(){return d}});var a=n(7462),o=n(3366),r=(n(7294),n(3905)),i=["components"],l={sidebar_position:5,title:"Remote Cache"},c="Remote Cache",s={unversionedId:"Guide/remote-cache",id:"Guide/remote-cache",title:"Remote Cache",description:"As your repo grows in size and complexity, the build takes longer and longer even locally. lage elegantly provides an incremental build capability given a locally available cache. When we pair the caching capability of lage with a cloud storage provider, we can speed up local builds with remote cache made available by Continuous Integration, or CI, jobs.",source:"@site/docs/Guide/remote-cache.md",sourceDirName:"Guide",slug:"/Guide/remote-cache",permalink:"/lage/docs/Guide/remote-cache",editUrl:"https://github.com/microsoft/lage/docs/Guide/remote-cache.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5,title:"Remote Cache"},sidebar:"tutorialSidebar",previous:{title:"Caching",permalink:"/lage/docs/Guide/cache"},next:{title:"Pipeline",permalink:"/lage/docs/Guide/pipeline"}},u=[{value:"1. Make sure to upgrade to latest <code>lage</code> (v1.0.0+)",id:"1-make-sure-to-upgrade-to-latest-lage-v100",children:[],level:2},{value:"2. Add <code>.env</code> in your <code>.gitignore</code> to make sure not to check those environment variables in",id:"2-add-env-in-your-gitignore-to-make-sure-not-to-check-those-environment-variables-in",children:[],level:2},{value:"3. Generate auth tokens from Azure storage account:",id:"3-generate-auth-tokens-from-azure-storage-account",children:[],level:2},{value:"4. Modify the <code>.env</code> file with the remote cache connection information",id:"4-modify-the-env-file-with-the-remote-cache-connection-information",children:[],level:2},{value:"5. Create a &quot;secret&quot; in the CI system for a Read/Write token",id:"5-create-a-secret-in-the-ci-system-for-a-readwrite-token",children:[],level:2},{value:"Notes",id:"notes",children:[{value:"Uploading cache to a remote is <em>not</em> the default",id:"uploading-cache-to-a-remote-is-not-the-default",children:[],level:3},{value:"Accessing environment variables",id:"accessing-environment-variables",children:[],level:3}],level:2}],p={toc:u};function d(e){var t=e.components,n=(0,o.Z)(e,i);return(0,r.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"remote-cache"},"Remote Cache"),(0,r.kt)("p",null,"As your repo grows in size and complexity, the build takes longer and longer even locally. ",(0,r.kt)("inlineCode",{parentName:"p"},"lage")," elegantly provides an incremental build capability given a locally available cache. When we pair the caching capability of ",(0,r.kt)("inlineCode",{parentName:"p"},"lage")," with a cloud storage provider, we can speed up local builds with remote cache made available by Continuous Integration, or CI, jobs. "),(0,r.kt)("p",null,'The theory is that when the CI job runs, it\'ll produce a "last known good" cache to be uploaded in a cloud storage, like Azure Blob Storage. The remote cache has been made available both for build-over-build speed ups in future CI jobs, as well as the local first build scenario.'),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"lage"),' has a "fallback cache" mechansim. ',(0,r.kt)("inlineCode",{parentName:"p"},"lage")," will look for cache in layers: first on disk, then on remote server. ",(0,r.kt)("inlineCode",{parentName:"p"},"lage")," will fill the local cache with the remote one if there is a remote cache hit. Next, ",(0,r.kt)("inlineCode",{parentName:"p"},"lage")," will save the locally built cache into the remote cache if the environment variable ",(0,r.kt)("inlineCode",{parentName:"p"},"LAGE_WRITE_REMOTE_CACHE")," is set ",(0,r.kt)("em",{parentName:"p"},"and")," if the cache is not configured to use a local provider."),(0,r.kt)("h1",{id:"setting-up-remote-cache---azure-blob-storage"},"Setting up remote cache - Azure Blob Storage"),(0,r.kt)("p",null,"Follow these steps to set up a remote cache "),(0,r.kt)("h2",{id:"1-make-sure-to-upgrade-to-latest-lage-v100"},"1. Make sure to upgrade to latest ",(0,r.kt)("inlineCode",{parentName:"h2"},"lage")," (v1.0.0+)"),(0,r.kt)("p",null,"See ",(0,r.kt)("a",{parentName:"p",href:"./migration"},"migration guide")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ yarn upgrade lage\n")),(0,r.kt)("h2",{id:"2-add-env-in-your-gitignore-to-make-sure-not-to-check-those-environment-variables-in"},"2. Add ",(0,r.kt)("inlineCode",{parentName:"h2"},".env")," in your ",(0,r.kt)("inlineCode",{parentName:"h2"},".gitignore")," to make sure not to check those environment variables in"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ touch .env\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"# .gitignore\n\n.env\nnode_modules\nlib\ndist\n")),(0,r.kt)("h2",{id:"3-generate-auth-tokens-from-azure-storage-account"},"3. Generate auth tokens from Azure storage account:"),(0,r.kt)("p",null,"Prerequisite is to have a working Storage Account with Blob Storage Container created. Note that container name, it'll be needed for Step 5."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Select the following for a ",(0,r.kt)("strong",{parentName:"li"},"read-only")," connection string:"),(0,r.kt)("li",{parentName:"ol"},"Set the start & expiry time to something appropriate"),(0,r.kt)("li",{parentName:"ol"},'Click "Generate SAS and connection string" button'),(0,r.kt)("li",{parentName:"ol"},'Save the "connection string" - this is your ',(0,r.kt)("strong",{parentName:"li"},"read-only")," connection string"),(0,r.kt)("li",{parentName:"ol"},'Click on "Access Keys" tab on the left'),(0,r.kt)("li",{parentName:"ol"},'Click "show keys"'),(0,r.kt)("li",{parentName:"ol"},'Save the "connection string" - this is your ',(0,r.kt)("strong",{parentName:"li"},"read-write")," connection string (alternatively, you can create a read-write SAS connection string)")),(0,r.kt)("h2",{id:"4-modify-the-env-file-with-the-remote-cache-connection-information"},"4. Modify the ",(0,r.kt)("inlineCode",{parentName:"h2"},".env")," file with the remote cache connection information"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'# .env file contents\n\n## This is required as of right now\nBACKFILL_CACHE_PROVIDER="azure-blob"\n\n## READ-ONLY SAS\nBACKFILL_CACHE_PROVIDER_OPTIONS={"connectionString":"the **read-only** connection string","container":"CONTAINER NAME"}\n')),(0,r.kt)("h2",{id:"5-create-a-secret-in-the-ci-system-for-a-readwrite-token"},'5. Create a "secret" in the CI system for a Read/Write token'),(0,r.kt)("p",null,"Here's an example snippet of Github Action with the correct environment variable set:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"- run: yarn lage build test --verbose\n  env:\n    BACKFILL_CACHE_PROVIDER: azure-blob\n    BACKFILL_CACHE_PROVIDER_OPTIONS: ${{ secrets.BACKFILL_CACHE_PROVIDER_OPTIONS }}\n    LAGE_WRITE_REMOTE_CACHE: true\n")),(0,r.kt)("p",null,'Create a secret named "BACKFILL_CACHE_PROVIDER_OPTIONS":'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{"connectionString":"the **read-write** connection string","container":"CONTAINER NAME"}\n')),(0,r.kt)("h2",{id:"notes"},"Notes"),(0,r.kt)("h3",{id:"uploading-cache-to-a-remote-is-not-the-default"},"Uploading cache to a remote is ",(0,r.kt)("em",{parentName:"h3"},"not")," the default"),(0,r.kt)("p",null,"Without the ",(0,r.kt)("inlineCode",{parentName:"p"},"LAGE_WRITE_REMOTE_CACHE")," environment variable, ",(0,r.kt)("inlineCode",{parentName:"p"},"lage")," no longer uploads build caches to the remote server."),(0,r.kt)("h3",{id:"accessing-environment-variables"},"Accessing environment variables"),(0,r.kt)("p",null,"Lage picks up your ",(0,r.kt)("inlineCode",{parentName:"p"},".env")," file contents using ",(0,r.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/dotenv"},(0,r.kt)("inlineCode",{parentName:"a"},"dotenv"))," utility under the hood (see ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/microsoft/backfill/blob/03b0e808d978faebf7be922a3f87d764ad0efce2/packages/utils-dotenv/README.md"},"backfill-utils-dotenv implementation"),")."),(0,r.kt)("p",null,"Need to access environment variables from the ",(0,r.kt)("inlineCode",{parentName:"p"},".env")," file in your application? You would need to setup a mechanism to inject them. Try using utilities like ",(0,r.kt)("inlineCode",{parentName:"p"},"dotenv")," (for Node.js) or ",(0,r.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/env-cmd"},(0,r.kt)("inlineCode",{parentName:"a"},"env-cmd"))," (for executing commands)."))}d.isMDXComponent=!0}}]);